import com.azure.ai.openai.OpenAIClient;
import com.azure.ai.openai.OpenAIClientBuilder;
import com.azure.ai.openai.models.*;
import com.azure.core.credential.AzureKeyCredential;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;

/**
 * OpenAIChatHandler handles the integration between Azure OpenAI and Azure AI Search.
 * It uses the "On Your Data" feature to ground AI responses in your private data.
 */
public class OpenAIChatHandler {

    // --- Configuration (Replace with your actual Azure values) ---
    private static final String OPENAI_ENDPOINT = "https://your-resource.openai.azure.com/";
    private static final String OPENAI_KEY = "YOUR_OPENAI_API_KEY";
    private static final String DEPLOYMENT_NAME = "your-model-deployment-name"; // e.g., "gpt-4o"

    private static final String SEARCH_ENDPOINT = "https://your-search-service.search.windows.net";
    private static final String SEARCH_KEY = "YOUR_SEARCH_ADMIN_KEY";
    private static final String SEARCH_INDEX = "your-index-name";

    public static void main(String[] args) {
        OpenAIChatHandler handler = new OpenAIChatHandler();
        
        // Example Question
        String question = "Where is the gym located and are pets allowed?";
        
        System.out.println("Processing your request...");
        String response = handler.askQuestion(question);
        
        System.out.println("\n--- AI RESPONSE ---");
        System.out.println(response);
    }

    /**
     * Sends a request to Azure OpenAI with an attached Data Source (Azure AI Search).
     */
    public String askQuestion(String userQuestion) {
        try {
            // 1. Initialize the OpenAI Client
            OpenAIClient client = new OpenAIClientBuilder()
                .endpoint(OPENAI_ENDPOINT)
                .credential(new AzureKeyCredential(OPENAI_KEY))
                .buildClient();

            // 2. Configure the Data Source Parameters
            // These parameters tell Azure OpenAI how to connect to your Search Index
            AzureSearchChatExtensionParameters searchParams = new AzureSearchChatExtensionParameters(
                SEARCH_ENDPOINT, 
                SEARCH_INDEX
            )
            .setAuthentication(new OnYourDataApiKeyAuthenticationOptions(SEARCH_KEY))
            .setInScope(true)              // true = only answer using your data
            .setStrictness(3)             // 1 (loose) to 5 (strict)
            .setQueryType(AzureSearchQueryType.SIMPLE);

            // 3. Wrap parameters into a Configuration object
            AzureSearchChatExtensionConfiguration searchConfig = 
                new AzureSearchChatExtensionConfiguration(searchParams);

            // 4. Prepare the Chat Messages (System + User)
            List<ChatRequestMessage> messages = new ArrayList<>();
            messages.add(new ChatRequestSystemMessage("You are a helpful facility assistant. Use the provided data to answer."));
            messages.add(new ChatRequestUserMessage(userQuestion));

            // 5. Build Chat Options and attach the Data Source
            ChatCompletionsOptions options = new ChatCompletionsOptions(messages);
            options.setTemperature(0.0);
            options.setMaxTokens(800);
            
            // This line links the Search Index to the AI Model request
            options.setDataSources(Arrays.asList(new ChatExtensionConfiguration(
                ChatExtensionType.AZURE_SEARCH, 
                searchConfig
            )));

            // 6. Execute the request
            // Azure performs: (Question -> Search -> Retrieve Facts -> AI Generation)
            ChatCompletions completions = client.getChatCompletions(DEPLOYMENT_NAME, options);

            // 7. Extract and return the final text content
            ChatResponseMessage responseMessage = completions.getChoices().get(0).getMessage();
            
            // Optional: You can also extract citations here if needed
            // List<AzureChatExtensionDataSourceResponseCitation> citations = 
            //    responseMessage.getContext().getCitations();

            return responseMessage.getContent();

        } catch (Exception e) {
            return "Error: " + e.getMessage();
        }
    }
}
